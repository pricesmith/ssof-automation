---
version: "3.9"
x-airflow-common:
  &airflow-common
  image: apache/airflow:latest
  environment: 
    - AIRFLOW__CORE__EXECUTOR=LocalExecutor
    - AIRFLOW__CORE__SQL_ALCHEMY_CONN=postgresql+psycopg2://postgres:postgres@postgres:5432/airflow
    - AIRFLOW__CORE__FERNET_KEY=FB0o_zt4e3Ziq3LdUUO7F2Z95cvFFx16hU8jTeR1ASM=
    - AIRFLOW__CORE__LOAD_EXAMPLES=False
    - AIRFLOW__CORE__LOGGING_LEVEL=INFO
  volumes:
    - ./dags:/opt/airflow/dags
    - ./airflow-data/logs:/opt/airflow/logs
    - ./airflow-data/plugins:/opt/airflow/plugins
    - ./airflow-data/airflow.cfg:/opt/airlfow/airflow.cfg
  depends_on:
  - postgres
services:
  postgres:
  image: postgres:12
  environment:
    - POSTGRES_USER=postgres
    - POSTGRES_PASSWORD=postgres
    - POSTGRES_DB=airflow
    - POSTGRES_PORT=5432
  ports:
    - "5432:5432"

  app: &app
    image: app
    build:
      context: src/
      labels:
        # static labels
        io.github.pricesmith.name: app
        io.github.pricesmith.description: lorem ipsum sit amet
        io.github.pricesmith.vendor: pricesmith
        io.github.pricesmith.vcs-url: https://github.com/pricesmith/sso-automation

        # dynamic variables from sdlc/vars, created by sdlc/build
        io.github.pricesmith.version: ${VERSION}
        io.github.pricesmith.build-date: ${BUILD_DATE}
        io.github.pricesmith.vcs-ref: ${VCS_REF}
        io.github.pricesmith.usage: ${VCS_URL}/blob/${VCS_REF}/README.md
        io.github.pricesmith.license: MIT
        io.github.pricesmith.dockerfile: src/Dockerfile
        io.github.pricesmith.vcs-type: Git

  troubleshooter:
    <<: *app
    entrypoint: /bin/bash
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN

  linter:
    <<: *app
    entrypoint: /opt/app/pylint

  optimistic:
    extends: app
    image: pricesmith/app

  pessimistic:
    extends: app
    image: pricesmith/app:${VERSION}

  airflow-init:
    << : *airflow-common
    container_name: airflow_init
    entrypoint: /bin/bash
    command:
      - -c
      - airflow users list || ( airflow db init &&
        airflow users create
          --role Admin
          --username airflow
          --password airflow
          --email airflow@airflow.com
          --firstname airflow
          --lastname airflow )
    restart: on-failure

  airflow-webserver:
    << : *airflow-common
    command: airflow webserver
    ports:
      - 8080:8080
    container_name: airflow_webserver
    restart: always

  airflow-scheduler:
    << : *airflow-common
    command: airflow scheduler
    container_name: airflow_scheduler
    restart: always
